### 前言

​	这篇博客是为了记录自己对单点协议的一些认识。

### 场景

​	举个生活中很常见的例子，咱们有时候无可避免的会去点外卖，这个过程中最头疼的其实就是拿外卖了。进小区需要门禁，进住宅楼需要进门，坐电梯也需要门禁，这是相当麻烦了，为了拿到外卖我们需要亲自过三次门禁！！！

​	那么有没有什么办法，能够让外卖员能够自由的进出小区、住宅楼、电梯呢？

### 授权机制的设计

简单的说 OAuth 就是授权机制的一种。数据的所有者告诉系统，同意授权第三方应用进入系统获取这些数据，系统从而产生一个短期的进入令牌，用来代替密码，供第三方应用使用。

#### 方案一

​	直接把门禁密码给外卖小哥

#### 方案二

​	我们可以在小区门禁机器那里添加一个**授权**的按钮，当外卖小哥输入住户信息按住按钮之后我们的手机会收到授权的弹窗。当我同意请求之后，门禁系统就会分配给外卖小哥一串**授权码**，当然这个密码肯定是有**有效期**的，外卖小哥输入这个**授权码**就能自由出入了。

### 互联网场景

咱们在[授权机制设计的方案二](#方案二)提到的对比互联网场景，其实就是一个 OAuth 设计。

**居民小区**其实就相当于**应用系统**，**外卖小哥**就相当于**第三方应用**，我扮演的角色就相当于**数据持有者**。

数据持有者去授权第三方应用获取持有者拥有的数据。

### 令牌和密码

* 令牌（token）就相当于是一个 有时效性的 密码（password）
* 令牌（token）可以被用户撤销，撤销之后立即失效
* 令牌（token）有权限范围，根据需要用户给第三方应用给予相应的范围。

> 上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点。

### OAuth2.0的四种方式

#### 授权码

**最常用最安全**

> 授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。

<img src="http://qiniuyun.whitenip.site/image/blog/oAuth2.0.png" title="授权码交互">

* 第一步，A 网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。下面就是 A 网站跳转 B 网站的一个示意链接。

  ```java
  https://b.com/oauth/authorize?
    response_type=code&
    client_id=CLIENT_ID&
    redirect_uri=CALLBACK_URL&
    scope=read
  // 上面 URL 中，`response_type`参数表示要求返回授权码（`code`），`client_id`参数让 B 知道是谁在请求，`redirect_uri`参数是 
  // B 接受或拒绝请求后的跳转网址，`scope`参数表示要求的授权范围（这里是只读）。
  ```

* 第二步，用户跳转后，B 网站会要求用户登录，然后询问是否同意给予 A 网站授权。用户表示同意，这时 B 网站就会跳回`redirect_uri`参数指定的网址。跳转时，会传回一个授权码，就像下面这样。

  ```java
  https://a.com/callback?code=AUTHORIZATION_CODE
  // 上面 URL 中，code参数就是授权码。
  
  ```

* 第三步，A 网站拿到授权码以后，就可以在后端，向 B 网站请求令牌。

  ```java
  https://b.com/oauth/token?
   client_id=CLIENT_ID&
   client_secret=CLIENT_SECRET&
   grant_type=authorization_code&
   code=AUTHORIZATION_CODE&
   redirect_uri=CALLBACK_URL
  		//上面 URL 中，client_id参数和client_secret参数用来让 B 确认 A 的身份（client_secret参数是保密的，因此只能在后端发请求），
     //grant_type参数的值是AUTHORIZATION_CODE，表示采用的授权方式是授权码，code参数是上一步拿到的授权码，redirect_uri参数是令牌
     //颁发后的回调网址。
  
  
  ```

  

*   第四步，B 网站收到请求以后，就会颁发令牌。具体做法是向`redirect_uri`指定的网址，发送一段 JSON 数据。

  上面 JSON 数据中，`access_token`字段就是令牌，A 网站在后端拿到了。

#### 隐藏式

#### 密码式

#### 凭证式

